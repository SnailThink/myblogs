终于有人把elasticsearch原理讲通了！

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105514.webp)

随着央视诗词大会的热播，小史开始对诗词感兴趣，最喜欢的就是飞花令的环节。

但是由于小史很久没有背过诗词了，飞一个字很难说出一句，很多之前很熟悉的诗句也想不起来。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105519.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105522.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105527.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105530.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105532.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105407.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105407.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105407.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105407.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105407.webp)

**【倒排索引】**

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105407.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105545.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105549.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105552.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105557.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105600.webp)

吕老师：但是我让你说出带“前”字的诗句，由于没有索引，你只能遍历脑海中所有诗词，当你的脑海中诗词量大的时候，就很难在短时间内得到结果了。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105603.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105607.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105611.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105614.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105618.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105620.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105624.webp)

**【索引量爆炸】**

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105627.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105630.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105633.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105636.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105640.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105645.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105648.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105651.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105654.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105656.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105659.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105702.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105705.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105709.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105712.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105715.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105718.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105722.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105413.webp)

**【搜索引擎原理】**

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105413.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105413.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105413.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105413.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105413.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105736.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105739.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105742.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105744.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105748.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105751.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105753.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105756.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105759.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105802.webp)

**【elasticsearch简介】**

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105805.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105811.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105814.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105817.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105819.webp)

吕老师：但是lucene还是一个库，必须要懂一点搜索引擎原理的人才能用的好，所以后来又有人基于lucene进行封装，写出了elasticsearch。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105822.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105825.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105828.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105830.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105833.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105836.webp)

**【elasticsearch基本概念】**

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105839.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105842.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105845.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105848.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105851.webp)

吕老师：类型是用来定义数据结构的，你可以认为是mysql中的一张表。文档就是最终的数据了，你可以认为一个文档就是一条记录。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105854.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105856.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105859.webp)

吕老师：比如一首诗，有诗题、作者、朝代、字数、诗内容等字段，那么首先，我们可以建立一个名叫poems的索引，然后创建一个名叫poem的类型，类型是通过mapping来定义每个字段的类型，比如诗题、作者、朝代都是keyword类型，诗内容是text类型，而字数是integer类型，最后就是把数据组织成json格式存放进去了。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105902.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105917.webp)

![img](D:/youdaoyun/qqF2991A6AAB0704D867F7C144E204C7F6/053833967db44de19296bb093f1a2854/640.webp)

吕老师：这个问题问得好，这涉及到分词的问题，keyword类型是不会分词的，直接根据字符串内容建立反向索引，text类型在存入elasticsearch的时候，会先分词，然后根据分词后的内容建立反向索引。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105922.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105925.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105928.webp)

吕老师：之前我们说过，elasticsearch把操作都封装成了http的api，我们只要给elasticsearch发送http请求就行。比如使用curl -XPUT 'http://ip:port/poems'，就能建立一个名为poems的索引，其他操作也是类似的。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105931.webp)

**【elasticsearch分布式原理】**

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105934.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105937.webp)

吕老师：没错，elasticsearch也是会对数据进行切分，同时每一个分片会保存多个副本，其原因和hdfs是一样的，都是为了保证分布式环境下的高可用。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105940.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105944.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105948.webp)

吕老师：没错，在elasticsearch中，节点是对等的，节点间会通过自己的一些规则选取集群的master，master会负责集群状态信息的改变，并同步给其他节点。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105950.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105953.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105956.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209105959.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110002.webp)

吕老师：注意，只有建立索引和类型需要经过master，数据的写入有一个简单的routing规则，可以route到集群中的任意节点，所以数据写入压力是分散在整个集群的。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110005.webp)

**【elk系统】**

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110008.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110010.webp)

吕老师：其实很多公司都用elasticsearch搭建elk系统，也就是日志分析系统。其中e就是elasticsearch，l是logstash，是一个日志收集系统，k是kibana，是一个数据可视化平台。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110012.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110018.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110020.webp)

吕老师：分析日志的用处可大了，你想，假如一个分布式系统有1000台机器，系统出现故障时，我要看下日志，还得一台一台登录上去查看，是不是非常麻烦？

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110023.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110028.webp)

吕老师：但是如果日志接入了elk系统就不一样。比如系统运行过程中，突然出现了异常，在日志中就能及时反馈，日志进入elk系统中，我们直接在kibana就能看到日志情况。如果再接入一些实时计算模块，还能做实时报警功能。

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110031.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110036.webp)

![img](https://gitee.com/VincentBlog/image/raw/master/image/20220209110039.webp)

**【笔记】**

小史学完了elasticsearch，在笔记本上写下了如下记录：

1、反向索引又叫倒排索引，是根据文章内容中的关键字建立索引

2、搜索引擎原理就是建立反向索引

3、elasticsearch在lucene的基础上进行封装，实现了分布式搜索引擎

4、elasticsearch中的索引、类型和文档的概念比较重要，类似于mysql中的数据库、表和行

5、elasticsearch也是master-slave架构，也实现了数据的分片和备份

6、elasticsearch一个典型应用就是elk日志分析系统