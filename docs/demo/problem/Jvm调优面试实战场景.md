

### JVM 调优

场景1:对账项目中有个bug，循环10000次执行一条sql语句，每次查询5万条数据，发生问题时候只看到Zabbix报警，

cpu占用率超过90%,假设代码肉眼看不出bug。怎么一步步分析问题，判断出事jvm调优么有做好，还是代码频繁创建对象

的bug 面试官想听到整个过程[发现问题-分析可能的问题-用什么工具逐一排除问题-怎么发现最终目标具体问题]

解决问题:

1.监控GC的状态

使用各种JVM工具，查看当前日志，分析当前JVM参数设置、并且发内心当前堆内存快照和GC日志，根据实际的各个区域

内存划分和GC执行时间觉得是否进行优化。

举一个例子:系统崩溃齐纳的一些现象

每次垃圾回收的时间越来越长，由之前的10ms延长到50ms左右，FullGC的时间也由之前的0.5s延长到4-5s FullGC的

次数越来越多，最频繁时隔不到1分钟就进行一次FullGC年老代的内存越来越大并且每次FullGC后年老代咩有内存被释

放，之后系统会无响应新的请求，逐渐到达OutOfMemoryError的临界点，这个时候就需要分析JVM内存快照dump。

2.生成堆的dump文件

通过JMX的Mbean生成的Heap信息，大小为一个3G(整个堆的大小)的hprof文件，如果没有启动JMX可以通过java的

jmap命令生成该文件。


3.分析dump文件

打开这个3G的堆信息文件，显然一般的windows没有这么大的内存，必须借助高配置的Linux几种工具打开该文件：

Visual VM

IBM HeapAnalyzer

JDK自带的Hprof工具

Mat(Eclipse专门的静态内存分析工具)推荐使用

tip:文件太大，建议使用Eclipse专门的静态内存分析工具Mat打开发分析

4.分析结果，判断是否需要优化

如果各项参数社会组合理，系统没有超时日志出现，GC频率不高，GC耗时不高，那么，没有必要进行GC优化

如果GC时间超过1-3秒，或者频繁GC则必须优化

>注:如果满足下面的指标，则一般不需要进行GC:
Minor GC执行时间不到50ms;
Minor GC执行不频繁，约10秒一次
Full GC执行时间不到1s
Full GC执行频率不算频繁，不低于10分钟1次

5.调整GC类型和内存分配

如果内存分配过大或过小，或者采用的GC收集器比较慢，则应该优先调整这些参数，并且找出一台或多台机器进行

beta，然后比较调优过的机器和没有调优的机器进行性能对比，并有针对性的做出最后选择

6.不断的分析和调整

通过不断的试验和试错，分析并找出合适的参数，如果找到最合适的参数，则将这些参数应用到所有的服务器

一般遇到问题就是打出当时的线程信息生成dump然后检查异常代码。



### 数据库查询优化的回答套路

跑一遍sql看时间是否符合预期

explain 看执行计划

行数不对 analyze 修正

添加索引 但是索引往往不是最优解

索引走错了 force index 强制走索引，还是会存在回表的情况

用覆盖索引去避免回表，直接查询索引上有的

联合索引 ，不能无限建，需要在高频查询的组合上创建

最左前缀原则: 按照索引定义的字段顺序写sql

合理安排联合索引字段的顺序

索引下推5.6之后的优化，减少回表的次数















